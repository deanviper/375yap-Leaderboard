<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>375yap Leaderboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Roboto & Charts loader -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root {
      --bg: #050607;
      --text: #B9C1C1;
      --panel-bg: rgba(26,26,26,0.9);
      --border: #B9C1C1;
      --orange: #FF3D14;
    }
    .light {
      --bg: #fff;
      --text: #000;
      --panel-bg: #f5f5f5;
      --border: #ccc;
      --orange: #FF3D14;
    }

    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family:'Roboto',sans-serif;
      transition: background .3s, color .3s;
    }
    button { cursor:pointer; border:none; background:none; }

    #mode-toggle {
      position: fixed;
      top:12px; right:12px;
      font-size:1.4rem;
      color: var(--orange);
      z-index:1000;
    }

    .container {
      max-width:1200px;
      margin:0 auto;
      padding:2rem 1rem 4rem;
      text-align:center;
    }
    .title {
      font-size:2.5rem;
      color: var(--orange);
      margin-bottom:1rem;
      text-shadow:0 2px 4px rgba(0,0,0,.7);
    }

    /* Dashboard = table + (no legend) */
    .dashboard {
      display:flex;
      justify-content:center;
      padding:0 20px;
      /* shift left 20% on desktop */
      padding-left:20vw;
    }
    .table-wrapper {
      flex:1;
      max-width:700px;
      width:75%;
    }
    #search-container {
      margin-bottom:.75rem;
      display:none;
    }
    #search-input {
      width:60%;
      max-width:300px;
      padding:6px 8px;
      border:1px solid var(--border);
      border-radius:4px;
      margin-right:4px;
    }
    #search-button {
      padding:6px 12px;
      background: var(--orange);
      color:#fff;
      border-radius:4px;
    }

    /* Table */
    #table_div table {
      width:100%;
      border-collapse:collapse;
      background: var(--panel-bg);
      border:1px solid var(--border);
      border-radius:8px;
      overflow:hidden;
    }
    #table_div th, #table_div td {
      padding:.75rem 1rem;
      font-size:.95rem;
      white-space:nowrap;
    }
    #table_div thead {
      background: var(--orange);
      color:#fff;
    }
    #table_div th:nth-child(2),
    #table_div td:nth-child(2) {
      text-align:left;
    }
    #table_div th:nth-child(3),
    #table_div td:nth-child(3) {
      text-align:right;
    }
    #table_div th:nth-child(4),
    #table_div td:nth-child(4) {
      text-align:center;
    }
    #table_div tbody tr:nth-child(odd) {
      background:#1E1E1E;
    }
    .pfp {
      width:24px; height:24px;
      border-radius:50%;
      vertical-align:middle;
      margin-right:.5rem;
    }

    @media (max-width:768px) {
      .dashboard {
        flex-direction:column;
        padding-left:0;
      }
      .table-wrapper {
        width:100%;
        max-width:600px;
      }
      /* keep mobile scrollable horizontally */
      #table_div { overflow-x:auto; }
    }
  </style>
</head>
<body>
  <button id="mode-toggle">ðŸŒ™</button>
  <div class="container">
    <h1 class="title">375yap Leaderboard</h1>
    <div class="dashboard">
      <div class="table-wrapper">
        <div id="search-container">
          <input id="search-input" placeholder="ðŸ” Search usernameâ€¦" />
          <button id="search-button">Go</button>
        </div>
        <div id="table_div"></div>
      </div>
    </div>
  </div>

  <script>
    // Dark/light toggle + load charts
    google.charts.load('current',{packages:['table']});
    const root = document.documentElement;
    const saved = localStorage.getItem('mode') || 'dark';
    root.classList.add(saved);
    document.getElementById('mode-toggle').textContent = saved==='dark'?'ðŸŒž':'ðŸŒ™';
    document.getElementById('mode-toggle').onclick = () => {
      const now = root.classList.contains('dark') ? 'light' : 'dark';
      root.classList.toggle('dark');
      root.classList.toggle('light');
      localStorage.setItem('mode', now);
      document.getElementById('mode-toggle').textContent = now==='dark'?'ðŸŒž':'ðŸŒ™';
    };

    // once charts loaded, kick off data load
    google.charts.setOnLoadCallback(loadData);

    function loadData() {
      const SHEET = '1nE4NPgFSHka7ByLLKaHWaVaKARMCrmb-_e1ZvpdV-cE';
      const BASE = `https://docs.google.com/spreadsheets/d/${SHEET}/gviz/tq?`;
      let pfpMap = {};

      // 1) PFPs from gid=0 (Sheet1)
      new google.visualization.Query(BASE+'gid=0&headers=1&tq=select%20B%2C%20F')
        .send(res => {
          const dt = res.getDataTable();
          for (let i=0; i<dt.getNumberOfRows(); i++) {
            pfpMap[ dt.getValue(i,0) ] = dt.getValue(i,1);
          }
          loadLB(pfpMap);
        });
    }

    function loadLB(pfpMap) {
      const SHEET = '1nE4NPgFSHka7ByLLKaHWaVaKARMCrmb-_e1ZvpdV-cE';
      const BASE = `https://docs.google.com/spreadsheets/d/${SHEET}/gviz/tq?sheet=Temporary%20LB&headers=1&tq=select%20A%2C%20B%20order%20by%20B%20desc`;
      new google.visualization.Query(BASE)
        .send(res => {
          const dt = res.getDataTable();
          const all = [];
          for (let i=0; i<dt.getNumberOfRows(); i++) {
            all.push({u: dt.getValue(i,0), pts: dt.getValue(i,1)});
          }
          draw(all, pfpMap);
        });
    }

    function draw(all, pfpMap) {
      const top50 = all.slice(0,50);
      const div = document.getElementById('table_div');
      div.innerHTML = '';
      const tbl = document.createElement('table');

      // header row
      const thead = tbl.createTHead().insertRow();
      ['#','User','Points',''].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        thead.appendChild(th);
      });

      // body rows
      const tbody = tbl.createTBody();
      top50.forEach((r, idx) => {
        const row = tbody.insertRow();
        // rank cell
        const rankCell = row.insertCell();
        rankCell.textContent = `${idx+1}.`;

        // user + avatar
        const userCell = row.insertCell();
        const img = document.createElement('img');
        img.src = pfpMap[r.u]||'';
        img.className = 'pfp';
        userCell.appendChild(img);
        userCell.appendChild(document.createTextNode(r.u));

        // points cell
        const ptsCell = row.insertCell();
        ptsCell.textContent = r.pts.toFixed(2);

        // blank cell for alignment
        row.insertCell();
      });

      div.appendChild(tbl);

      // show search if more than 50
      if (all.length > 50) {
        document.getElementById('search-container').style.display = 'block';
        document.getElementById('search-button').onclick = () => {
          const q = document.getElementById('search-input').value.trim().toLowerCase();
          const found = all.find(x => x.u.toLowerCase() === q);
          if (!found) return alert('User not found');
          draw([found], pfpMap);
        };
      }
    }
  </script>
</body>
</html>
