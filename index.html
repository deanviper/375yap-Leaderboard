<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>375yap Leaderboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Roboto & Charts loader -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root {
      --bg: #050607;
      --text: #B9C1C1;
      --panel-bg: rgba(26,26,26,0.9);
      --border: #B9C1C1;
      --orange: #FF3D14;
    }
    .light {
      --bg: #fff;
      --text: #000;
      --panel-bg: #f5f5f5;
      --border: #ccc;
      --orange: #FF3D14;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family:'Roboto',sans-serif;
      transition: background .3s, color .3s;
    }
    button { cursor:pointer; border:none; background:none; }
    #mode-toggle {
      position: fixed; top:12px; right:12px;
      font-size:1.4rem; color: var(--orange); z-index:1000;
    }
    .container {
      max-width:1000px; margin:0 auto;
      padding:2rem 1rem 4rem;
      text-align:center;
    }
    h1 {
      font-size:2.5rem; color: var(--orange);
      text-shadow:0 2px 4px rgba(0,0,0,.7);
      margin-bottom:1rem;
    }
    #search-container {
      display:none; margin-bottom:1rem;
    }
    #search-input {
      width:60%; max-width:300px;
      padding:6px 8px;
      border:1px solid var(--border);
      border-radius:4px;
      margin-right:4px;
    }
    #search-button {
      padding:6px 12px;
      background: var(--orange);
      color:#fff;
      border-radius:4px;
    }
    .dashboard {
      display:flex; justify-content:center;
      padding:0 1rem;
    }
    .table-wrapper {
      width:75%; max-width:700px; flex-shrink:0;
      border:1px solid var(--border);
      border-radius:8px;
      overflow:hidden;
      background: var(--panel-bg);
      box-shadow:0 8px 24px rgba(0,0,0,0.5);
    }
    #table_div { width:100%; max-height:70vh; overflow-y:auto; }
    #table_div table {
      width:100%; border-collapse:collapse;
      table-layout:fixed;
    }
    #table_div th, #table_div td {
      padding:.75rem 1rem; font-size:.95rem;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    #table_div thead { background: var(--orange); color:#fff; }
    #table_div th:nth-child(1), #table_div td:nth-child(1) {
      width:2.5rem; text-align:center;
    }
    #table_div th:nth-child(3), #table_div td:nth-child(3) {
      text-align:right;
    }
    #table_div tbody tr:nth-child(odd) { background:#1E1E1E; }
    .pfp {
      width:24px; height:24px;
      border-radius:50%;
      vertical-align:middle;
      margin-right:.5rem;
    }
    @media (max-width:768px) {
      .dashboard { flex-direction:column; }
      .table-wrapper { width:100%; }
      #table_div { overflow-x:auto; }
    }
  </style>
</head>
<body>
  <button id="mode-toggle">🌙</button>
  <div class="container">
    <h1>375yap Leaderboard</h1>
    <div id="search-container">
      <input id="search-input" placeholder="🔍 Search username…" />
      <button id="search-button">Go</button>
    </div>
    <div class="dashboard">
      <div class="table-wrapper">
        <div id="table_div"></div>
      </div>
    </div>
  </div>

  <script>
    google.charts.load('current',{packages:['table']});
    const root = document.documentElement;
    const saved = localStorage.getItem('mode') || 'dark';
    root.classList.add(saved);
    document.getElementById('mode-toggle').textContent = saved==='dark'?'🌞':'🌙';
    document.getElementById('mode-toggle').onclick = () => {
      const now = root.classList.contains('dark') ? 'light' : 'dark';
      root.classList.toggle('dark');
      root.classList.toggle('light');
      localStorage.setItem('mode', now);
      document.getElementById('mode-toggle').textContent = now==='dark'?'🌞':'🌙';
    };

    google.charts.setOnLoadCallback(init);
    function init(){
      const SHEET_KEY = '1nE4NPgFSHka7ByLLKaHWaVaKARMCrmb-_e1ZvpdV-cE';
      fetchPFPs(SHEET_KEY).then(pfpMap => loadScores(SHEET_KEY, pfpMap));
    }
    function fetchPFPs(key){
      return new Promise(resolve => {
        const q = new google.visualization.Query(
          `https://docs.google.com/spreadsheets/d/${key}/gviz/tq?gid=0&headers=1&tq=select%20B%2C%20F`
        );
        q.send(res => {
          const dt = res.getDataTable(), map={};
          for(let i=0;i<dt.getNumberOfRows();i++){
            map[dt.getValue(i,0)] = dt.getValue(i,1);
          }
          resolve(map);
        });
      });
    }
    function loadScores(key, pfpMap){
      const q = new google.visualization.Query(
        `https://docs.google.com/spreadsheets/d/${key}/gviz/tq?sheet=Temporary%20LB&headers=1&tq=select%20A%2C%20B%20order%20by%20B%20desc`
      );
      q.send(res => {
        const dt = res.getDataTable();
        const all = [];
        for(let i=0;i<dt.getNumberOfRows();i++){
          all.push({u:dt.getValue(i,0), pts:dt.getValue(i,1)});
        }
        render(all, pfpMap);
      });
    }
    function render(all, pfpMap){
      const top50 = all.slice(0,50);
      const div = document.getElementById('table_div'); div.innerHTML='';
      const table = document.createElement('table');
      const thead = table.createTHead().insertRow();
      ['#','User','Points',''].forEach(h=>{
        const th=document.createElement('th'); th.textContent=h; thead.appendChild(th);
      });
      const tbody = table.createTBody();
      top50.forEach((r,i)=>{
        const row = tbody.insertRow();
        // rank with single dot
        row.insertCell().textContent = (i+1) + '.';
        // user + pfp
        const cu = row.insertCell();
        const img = document.createElement('img');
        img.src = pfpMap[r.u] || '';
        img.className = 'pfp';
        cu.appendChild(img);
        cu.appendChild(document.createTextNode(r.u));
        // points fixed to 2 decimals
        row.insertCell().textContent = r.pts.toFixed(2);
        // spacer
        row.insertCell();
      });
      div.appendChild(table);

      if(all.length>50){
        document.getElementById('search-container').style.display='block';
        document.getElementById('search-button').onclick=()=>{
          const q=document.getElementById('search-input').value.trim().toLowerCase();
          const found=all.find(x=>x.u.toLowerCase()===q);
          if(!found) return alert('User not found');
          render([found], pfpMap);
        };
      }
    }
  </script>
</body>
</html>
